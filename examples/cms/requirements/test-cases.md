# CMS 测试用例文档

## 实体测试用例

### TC001: 创建 Style 记录
- **前置条件**: 用户已登录且有创建权限
- **输入数据**: 
  ```json
  {
    "label": "Manga",
    "slug": "manga",
    "description": "Japanese comic style",
    "type": "animation",
    "thumb_key": "styles/manga-thumb.jpg",
    "priority": 100,
    "status": "draft"
  }
  ```
- **预期结果**:
  1. 创建新的 Style 记录
  2. 自动生成 UUID id
  3. 设置 created_at 为当前时间
  4. 设置 updated_at 为当前时间
  5. 状态默认为 'draft'
- **后置验证**: Style 记录存在于数据库中，字段值正确

### TC002: 更新 Style 记录
- **前置条件**: Style 记录存在，用户有编辑权限
- **输入数据**: 
  ```json
  {
    "id": "existing-style-id",
    "label": "Updated Manga",
    "description": "Updated description"
  }
  ```
- **预期结果**:
  1. 更新指定字段
  2. updated_at 自动更新为当前时间
  3. 其他字段保持不变
- **后置验证**: 记录更新成功，updated_at 时间更新

### TC003: 删除 Style 记录
- **前置条件**: Style 记录存在，用户有删除权限（仅管理员）
- **输入数据**: `styleId: "style-to-delete"`
- **预期结果**: 
  1. 记录从数据库中物理删除
  2. 相关的版本快照中该记录被标记为已删除
- **后置验证**: 记录不再存在，查询返回空

### TC004: 查询 Style 记录列表
- **前置条件**: 数据库中存在多条 Style 记录
- **输入数据**: 
  ```json
  {
    "status": "published",
    "page": 1,
    "limit": 20,
    "sortBy": "priority",
    "sortOrder": "desc"
  }
  ```
- **预期结果**:
  1. 返回符合条件的记录列表
  2. 按 priority 降序排列
  3. 分页信息正确
- **后置验证**: 结果集合符合筛选条件和排序要求

## 用户权限测试用例

### TC101: 管理员权限测试
- **前置条件**: 用户角色为 Admin
- **测试场景**:
  1. 创建 Style 记录 ✓
  2. 编辑任意状态的 Style 记录 ✓
  3. 删除 Style 记录 ✓
  4. 修改 Style 状态到任意值 ✓
  5. 执行排序操作 ✓
  6. 发布版本 ✓
  7. 回滚版本 ✓
- **预期结果**: 所有操作成功执行

### TC102: 运营人员权限测试
- **前置条件**: 用户角色为 Operator
- **测试场景**:
  1. 创建 Style 记录 ✓
  2. 编辑自己创建的 Style 记录 ✓
  3. 修改状态为 draft/published ✓
  4. 修改状态为 offline ❌
  5. 删除 Style 记录 ❌
  6. 执行排序操作 ✓
- **预期结果**: 允许的操作成功，禁止的操作被拒绝

### TC103: 查看者权限测试
- **前置条件**: 用户角色为 Viewer
- **测试场景**:
  1. 查看 published 状态的 Style 记录 ✓
  2. 查看 draft/offline 状态的记录 ❌
  3. 任何修改操作 ❌
- **预期结果**: 只能查看已发布内容，无修改权限

## 状态管理测试用例

### TC201: Style 状态转换
- **前置条件**: Style 记录存在
- **测试场景**:
  ```
  draft → published ✓
  draft → offline ✓ (仅管理员)
  published → draft ✓
  published → offline ✓
  offline → draft ✓ (仅管理员)
  offline → published ✓ (仅管理员)
  ```
- **预期结果**: 状态转换按权限规则执行

### TC202: 状态变更的计算属性影响
- **前置条件**: 系统中有多个不同状态的 Style 记录
- **测试场景**: 修改 Style 状态
- **预期结果**:
  1. publishedStyleCount 自动更新
  2. draftStyleCount 自动更新
  3. offlineStyleCount 自动更新
- **后置验证**: 计数属性准确反映状态变更

## 排序管理测试用例

### TC301: 拖拽排序操作
- **前置条件**: 存在多个 Style 记录
- **输入数据**:
  ```json
  {
    "draggedId": "style-1",
    "targetId": "style-3",
    "position": "before"
  }
  ```
- **预期结果**:
  1. 计算新的 priority 值
  2. 更新受影响记录的 priority
  3. 排序结果立即生效
- **后置验证**: 所有记录的 priority 值保证正确排序

### TC302: Priority 自动计算
- **前置条件**: 执行排序操作
- **测试场景**: 将 priority=50 的记录移动到 priority=30 和 priority=20 之间
- **预期结果**: 
  1. 移动的记录 priority 更新为 25
  2. 其他记录 priority 保持不变（如果不需要调整）
- **后置验证**: 排序逻辑正确

### TC303: 批量排序更新
- **前置条件**: 需要重新排列多个记录
- **输入数据**: 新的排序顺序数组
- **预期结果**:
  1. 所有记录的 priority 批量更新
  2. 更新操作原子性执行
- **后置验证**: 最终排序结果正确

## 版本管理测试用例

### TC401: 创建版本快照
- **前置条件**: 系统中有已发布的 Style 记录
- **输入数据**: 
  ```json
  {
    "versionName": "v1.0.0",
    "description": "Initial release"
  }
  ```
- **预期结果**:
  1. 创建新的版本记录
  2. 快照所有 published 状态的 Style 记录
  3. 记录版本创建时间和创建者
- **后置验证**: 版本快照数据完整准确

### TC402: 版本回滚操作
- **前置条件**: 存在历史版本快照
- **输入数据**: `versionId: "version-to-rollback"`
- **预期结果**:
  1. 恢复指定版本的所有 Style 记录
  2. 删除当前版本中不存在于目标版本的记录
  3. 创建回滚操作记录
- **后置验证**: 系统状态与目标版本一致

### TC403: 版本比较
- **前置条件**: 存在多个版本
- **输入数据**: 
  ```json
  {
    "sourceVersion": "v1.0.0",
    "targetVersion": "v1.1.0"
  }
  ```
- **预期结果**:
  1. 返回两个版本的差异
  2. 标识新增、修改、删除的记录
  3. 显示字段级别的变更
- **后置验证**: 差异结果准确

## 业务流程测试用例

### TC501: 完整发布流程
- **测试场景**: 从创建到发布的完整流程
- **步骤**:
  1. 创建 Style 记录（状态 draft）
  2. 编辑和完善内容
  3. 修改状态为 published
  4. 创建版本快照
  5. 发布版本
- **预期结果**: 记录在前端可见，版本记录正确

### TC502: 紧急下线流程
- **测试场景**: 紧急下线已发布内容
- **步骤**:
  1. 定位需要下线的 Style 记录
  2. 修改状态为 offline
  3. 验证前端不再显示
  4. 记录下线操作日志
- **预期结果**: 内容立即从前端消失

### TC503: 批量内容管理
- **测试场景**: 批量操作多个 Style 记录
- **步骤**:
  1. 选择多个记录
  2. 批量修改状态
  3. 批量调整 priority
  4. 批量删除（管理员）
- **预期结果**: 所有操作批量生效

## 数据一致性测试用例

### TC601: Slug 唯一性验证
- **测试场景**: 尝试创建相同 slug 的记录
- **预期结果**: 系统拒绝创建，返回唯一性错误

### TC602: 关联数据一致性
- **测试场景**: 删除 Style 记录后检查相关数据
- **预期结果**: 版本快照、操作日志等相关数据状态正确

### TC603: 并发操作测试
- **测试场景**: 多用户同时操作同一 Style 记录
- **预期结果**: 
  1. 最后的操作生效
  2. 数据不出现损坏
  3. 操作冲突得到正确处理

## 性能测试用例

### TC701: 大数据量列表查询
- **前置条件**: 数据库中有 10000+ Style 记录
- **测试场景**: 分页查询、筛选、排序
- **性能指标**: 响应时间 < 500ms

### TC702: 批量排序性能
- **前置条件**: 需要重排 100+ 记录
- **测试场景**: 执行批量排序操作
- **性能指标**: 操作完成时间 < 2s

### TC703: 版本快照性能
- **前置条件**: 1000+ published 记录
- **测试场景**: 创建版本快照
- **性能指标**: 快照创建时间 < 5s

## 异常情况测试用例

### TC801: 网络异常处理
- **测试场景**: 网络中断时的操作行为
- **预期结果**: 
  1. 操作失败给出明确提示
  2. 数据不出现不一致状态
  3. 支持操作重试

### TC802: 数据格式错误
- **测试场景**: 提交不符合格式要求的数据
- **预期结果**: 
  1. 前端验证拦截错误数据
  2. 后端验证提供详细错误信息
  3. 数据库完整性约束生效

### TC803: 权限变更影响
- **测试场景**: 用户权限在操作过程中被变更
- **预期结果**: 
  1. 当前操作正常完成
  2. 后续操作按新权限执行
  3. 不出现权限漏洞