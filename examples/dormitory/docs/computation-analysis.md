# Computation Analysis - Dormitory Management System

## Entity: User

### Entity-Level Analysis
- **Purpose**: Represents all system users including students, dormitory heads, and administrators
- **Creation Source**: Pre-existing in the system (created through external registration/admin panel)
- **Update Requirements**: Role changes, point deductions, eviction status changes
- **Deletion Strategy**: Soft delete via status field (active/evicted)

### Property Analysis

#### Property: id
- **Type**: string
- **Purpose**: Unique identifier
- **Data Source**: System-generated
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: IDs are auto-generated by the framework

#### Property: name
- **Type**: string
- **Purpose**: User's display name
- **Data Source**: External registration/admin input
- **Update Frequency**: Never (in this system scope)
- **Computation Decision**: None
- **Reasoning**: Set during user creation outside interaction scope

#### Property: email
- **Type**: string
- **Purpose**: Unique login identifier
- **Data Source**: External registration
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Set during registration outside system scope

#### Property: role
- **Type**: string
- **Purpose**: User role (admin/dormHead/student)
- **Data Source**: Admin assignment or AppointDormHead interaction
- **Update Frequency**: When appointed as dormHead
- **Strong Consistency**: No - Admin-driven change
- **Computation Decision**: StateMachine
- **Reasoning**: Role transitions from student to dormHead via interaction
- **Dependencies**: AppointDormHead interaction
- **Calculation Method**: Transition from 'student' to 'dormHead' when appointed

#### Property: points
- **Type**: number
- **Purpose**: Behavior points (starts at 100)
- **Data Source**: Calculated from violations
- **Update Frequency**: When violations recorded
- **Strong Consistency**: Yes - Always equals 100 minus sum of violations
- **Computation Decision**: Custom (complex calculation: 100 - sum with floor at 0)
- **Reasoning**: Needs to calculate 100 - sum(violations.points) with minimum of 0
- **Dependencies**: UserViolationRelation, ViolationRecord.points
- **Calculation Method**: 100 - Sum of all related ViolationRecord.points, floored at 0

#### Property: status
- **Type**: string
- **Purpose**: User status (active/evicted)
- **Data Source**: ReviewEvictionRequest interaction
- **Update Frequency**: When eviction approved
- **Strong Consistency**: No - Admin-driven state change
- **Computation Decision**: StateMachine
- **Reasoning**: State transition from active to evicted via interaction
- **Dependencies**: ReviewEvictionRequest interaction
- **Calculation Method**: Transition from 'active' to 'evicted' when eviction approved

#### Property: evictedAt
- **Type**: number (optional)
- **Purpose**: Timestamp when user was evicted
- **Data Source**: ReviewEvictionRequest interaction
- **Update Frequency**: Once when evicted
- **Strong Consistency**: No - Set on eviction approval
- **Computation Decision**: StateMachine with computeValue
- **Reasoning**: Set to current timestamp when status changes to evicted
- **Dependencies**: ReviewEvictionRequest interaction
- **Calculation Method**: Set to Date.now() when transitioning to evicted state

### Computed Properties (Additional)

#### Property: currentPoints (computed property)
- **Type**: number
- **Purpose**: Current behavior points
- **Data Source**: Calculation from violations
- **Strong Consistency**: Yes
- **Computation Decision**: Already covered in 'points' property above
- **Reasoning**: Same as points property

#### Property: isEligibleForEviction (computed property)
- **Type**: boolean
- **Purpose**: Whether user can be evicted
- **Data Source**: Points value
- **Strong Consistency**: Yes - Always equals (points < 60)
- **Computation Decision**: computed function
- **Reasoning**: Simple boolean check based on current record
- **Dependencies**: points property
- **Calculation Method**: Return points < 60

### Entity Computation Decision
- **Type**: None
- **Source**: N/A
- **Reasoning**: Users are created outside the interaction system (external registration)
- **Dependencies**: N/A
- **Calculation Method**: N/A

## Entity: Dormitory

### Entity-Level Analysis
- **Purpose**: Represents dormitory rooms in the system
- **Creation Source**: CreateDormitory interaction
- **Update Requirements**: Status changes (active/inactive)
- **Deletion Strategy**: Soft delete via status field

### Property Analysis

#### Property: id
- **Type**: string
- **Purpose**: Unique identifier
- **Data Source**: System-generated
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Auto-generated by framework

#### Property: name
- **Type**: string
- **Purpose**: Dormitory identifier
- **Data Source**: CreateDormitory payload
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Set during creation, never changes

#### Property: capacity
- **Type**: number
- **Purpose**: Number of beds (4-6)
- **Data Source**: CreateDormitory payload
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Set during creation, never changes

#### Property: floor
- **Type**: number
- **Purpose**: Floor number
- **Data Source**: CreateDormitory payload
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Set during creation

#### Property: building
- **Type**: string
- **Purpose**: Building identifier
- **Data Source**: CreateDormitory payload
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Set during creation

#### Property: status
- **Type**: string
- **Purpose**: Dormitory status (active/inactive)
- **Data Source**: Default 'active', may change via admin actions
- **Update Frequency**: Rare admin updates
- **Strong Consistency**: No - Admin-driven
- **Computation Decision**: defaultValue only (no computation needed in Stage 1)
- **Reasoning**: Simple default, future admin interactions may update
- **Dependencies**: None currently
- **Calculation Method**: Default to 'active'

#### Property: createdAt
- **Type**: number
- **Purpose**: Creation timestamp
- **Data Source**: System timestamp
- **Update Frequency**: Never
- **Computation Decision**: defaultValue
- **Reasoning**: Set once at creation
- **Calculation Method**: Math.floor(Date.now()/1000)

### Computed Properties (Additional)

#### Property: occupancy (computed property)
- **Type**: number
- **Purpose**: Count of occupied beds
- **Data Source**: Bed status counts
- **Strong Consistency**: Yes - Always equals count of occupied beds
- **Computation Decision**: Count with filter
- **Reasoning**: Count beds where status='occupied'
- **Dependencies**: DormitoryBedRelation, Bed.status
- **Calculation Method**: Count related beds where bed.status = 'occupied'

#### Property: availableBeds (computed property)
- **Type**: number
- **Purpose**: Number of vacant beds
- **Data Source**: Capacity minus occupancy
- **Strong Consistency**: Yes - Always equals capacity - occupancy
- **Computation Decision**: computed function
- **Reasoning**: Simple calculation from current record
- **Dependencies**: capacity property, occupancy computation
- **Calculation Method**: capacity - occupancy

#### Property: occupancyRate (computed property)
- **Type**: number
- **Purpose**: Percentage of beds occupied
- **Data Source**: Occupancy and capacity
- **Strong Consistency**: Yes - Always equals (occupancy/capacity) × 100
- **Computation Decision**: computed function
- **Reasoning**: Simple percentage calculation
- **Dependencies**: occupancy computation, capacity property
- **Calculation Method**: (occupancy / capacity) × 100

### Entity Computation Decision
- **Type**: Transform
- **Source**: InteractionEventEntity
- **Reasoning**: Dormitories are created via CreateDormitory interaction
- **Dependencies**: CreateDormitory interaction event, payload data
- **Calculation Method**: When CreateDormitory fires, create new Dormitory with data from payload

## Entity: Bed

### Entity-Level Analysis
- **Purpose**: Individual bed within a dormitory
- **Creation Source**: Automatically created with Dormitory (based on capacity)
- **Update Requirements**: Status changes (vacant/occupied/maintenance)
- **Deletion Strategy**: Hard delete (only when dormitory deleted)

### Property Analysis

#### Property: id
- **Type**: string
- **Purpose**: Unique identifier
- **Data Source**: System-generated
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Auto-generated by framework

#### Property: number
- **Type**: string
- **Purpose**: Bed identifier within room (A, B, C, etc.)
- **Data Source**: Generated during dormitory creation
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Set during creation based on position

#### Property: status
- **Type**: string
- **Purpose**: Bed status (vacant/occupied/maintenance)
- **Data Source**: State transitions via interactions
- **Update Frequency**: On assignment/eviction
- **Strong Consistency**: No - Interaction-driven state changes
- **Computation Decision**: StateMachine
- **Reasoning**: State transitions between vacant/occupied via interactions
- **Dependencies**: AssignUserToDormitory, ReviewEvictionRequest interactions
- **Calculation Method**: vacant→occupied (assign), occupied→vacant (evict)

#### Property: assignedAt
- **Type**: number (optional)
- **Purpose**: Timestamp when last assigned
- **Data Source**: AssignUserToDormitory interaction
- **Update Frequency**: When assigned
- **Strong Consistency**: No - Set on assignment
- **Computation Decision**: StateMachine with computeValue
- **Reasoning**: Set to current timestamp when status changes to occupied
- **Dependencies**: AssignUserToDormitory interaction
- **Calculation Method**: Set to Date.now() when transitioning to occupied

### Entity Computation Decision
- **Type**: Transform
- **Source**: Dormitory entity
- **Reasoning**: Beds are created automatically when Dormitory is created
- **Dependencies**: Dormitory creation, capacity value
- **Calculation Method**: When Dormitory created, generate capacity number of Beds with sequential numbers

## Entity: ViolationRecord

### Entity-Level Analysis
- **Purpose**: Track user behavior violations
- **Creation Source**: RecordViolation interaction
- **Update Requirements**: None (immutable records)
- **Deletion Strategy**: Never deleted (audit trail)

### Property Analysis

#### Property: id
- **Type**: string
- **Purpose**: Unique identifier
- **Data Source**: System-generated
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Auto-generated by framework

#### Property: description
- **Type**: string
- **Purpose**: Violation details
- **Data Source**: RecordViolation payload
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Set during creation, immutable

#### Property: points
- **Type**: number
- **Purpose**: Points deducted
- **Data Source**: RecordViolation payload
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Set during creation, immutable

#### Property: category
- **Type**: string
- **Purpose**: Violation category
- **Data Source**: RecordViolation payload
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Set during creation, immutable

#### Property: createdAt
- **Type**: number
- **Purpose**: Timestamp when recorded
- **Data Source**: System timestamp
- **Update Frequency**: Never
- **Computation Decision**: defaultValue
- **Reasoning**: Set once at creation
- **Calculation Method**: Math.floor(Date.now()/1000)

#### Property: recordedBy
- **Type**: string
- **Purpose**: Name of dormHead who recorded
- **Data Source**: RecordViolation interaction user
- **Update Frequency**: Never
- **Computation Decision**: None (set in Transform)
- **Reasoning**: Captured from interaction user during creation

### Entity Computation Decision
- **Type**: Transform
- **Source**: InteractionEventEntity
- **Reasoning**: ViolationRecords are created via RecordViolation interaction
- **Dependencies**: RecordViolation interaction event, user context, payload data
- **Calculation Method**: When RecordViolation fires, create new ViolationRecord with payload data and user.name as recordedBy

## Entity: EvictionRequest

### Entity-Level Analysis
- **Purpose**: Formal eviction requests
- **Creation Source**: SubmitEvictionRequest interaction
- **Update Requirements**: Status changes, admin notes
- **Deletion Strategy**: Never deleted (audit trail)

### Property Analysis

#### Property: id
- **Type**: string
- **Purpose**: Unique identifier
- **Data Source**: System-generated
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Auto-generated by framework

#### Property: reason
- **Type**: string
- **Purpose**: Detailed eviction reason
- **Data Source**: SubmitEvictionRequest payload
- **Update Frequency**: Never
- **Computation Decision**: None
- **Reasoning**: Set during creation, immutable

#### Property: status
- **Type**: string
- **Purpose**: Request status (pending/approved/rejected)
- **Data Source**: State transitions via ReviewEvictionRequest
- **Update Frequency**: Once when reviewed
- **Strong Consistency**: No - Admin-driven decision
- **Computation Decision**: StateMachine
- **Reasoning**: State transition from pending to approved/rejected
- **Dependencies**: ReviewEvictionRequest interaction
- **Calculation Method**: pending→approved/rejected based on decision

#### Property: requestedAt
- **Type**: number
- **Purpose**: Timestamp when requested
- **Data Source**: System timestamp
- **Update Frequency**: Never
- **Computation Decision**: defaultValue
- **Reasoning**: Set once at creation
- **Calculation Method**: Math.floor(Date.now()/1000)

#### Property: decidedAt
- **Type**: number (optional)
- **Purpose**: Timestamp when decision made
- **Data Source**: ReviewEvictionRequest interaction
- **Update Frequency**: Once when reviewed
- **Strong Consistency**: No - Set on review
- **Computation Decision**: StateMachine with computeValue
- **Reasoning**: Set when status changes from pending
- **Dependencies**: ReviewEvictionRequest interaction
- **Calculation Method**: Set to Date.now() when transitioning from pending

#### Property: adminNotes
- **Type**: string (optional)
- **Purpose**: Admin's decision notes
- **Data Source**: ReviewEvictionRequest payload
- **Update Frequency**: Once when reviewed
- **Strong Consistency**: No - Admin input
- **Computation Decision**: StateMachine with computeValue
- **Reasoning**: Set from payload when reviewed
- **Dependencies**: ReviewEvictionRequest interaction payload
- **Calculation Method**: Set from event.payload.adminNotes when reviewed

### Entity Computation Decision
- **Type**: Transform
- **Source**: InteractionEventEntity
- **Reasoning**: EvictionRequests are created via SubmitEvictionRequest interaction
- **Dependencies**: SubmitEvictionRequest interaction event, payload data
- **Calculation Method**: When SubmitEvictionRequest fires, create new EvictionRequest with status='pending'

## Relation: UserDormitoryRelation

### Relation Analysis
- **Purpose**: Assigns students to dormitories
- **Creation**: Via AssignUserToDormitory interaction
- **Deletion Requirements**: Hard delete when user evicted (no need for history)
- **Update Requirements**: No property updates needed
- **State Management**: No status field (existence = assigned)
- **Computation Decision**: StateMachine only (hard delete pattern)
- **Reasoning**: Need both creation and deletion capability, no audit trail needed
- **Dependencies**: AssignUserToDormitory and ReviewEvictionRequest interactions
- **Calculation Method**: Create on assignment, delete on eviction approval

### Relation Properties

#### Property: assignedAt
- **Type**: number
- **Purpose**: Assignment timestamp
- **Computation Decision**: defaultValue
- **Reasoning**: Set once at creation
- **Calculation Method**: Math.floor(Date.now()/1000)

#### Property: assignedBy
- **Type**: string
- **Purpose**: Admin who made assignment
- **Computation Decision**: None (set during creation)
- **Reasoning**: Captured from interaction user

## Relation: UserBedRelation

### Relation Analysis
- **Purpose**: Assigns users to specific beds
- **Creation**: Via AssignUserToDormitory interaction
- **Deletion Requirements**: Hard delete when user evicted
- **Update Requirements**: No property updates
- **State Management**: No status (existence = assigned)
- **Computation Decision**: StateMachine only (hard delete pattern)
- **Reasoning**: Need both creation and deletion capability
- **Dependencies**: AssignUserToDormitory and ReviewEvictionRequest interactions
- **Calculation Method**: Create on assignment, delete on eviction

## Relation: DormitoryBedRelation

### Relation Analysis
- **Purpose**: Links beds to their dormitory
- **Creation**: Automatically when beds are created with dormitory
- **Deletion Requirements**: Only when dormitory deleted
- **Update Requirements**: None
- **State Management**: None needed
- **Computation Decision**: None
- **Reasoning**: Created automatically with Bed entity via Transform
- **Dependencies**: N/A (automatic with Bed creation)
- **Calculation Method**: N/A (automatic)

## Relation: DormitoryDormHeadRelation

### Relation Analysis
- **Purpose**: Assigns dormitory head to manage a dormitory
- **Creation**: Via AppointDormHead interaction
- **Deletion Requirements**: Could be removed when dormHead role changes (future enhancement)
- **Update Requirements**: No property updates in Stage 1
- **State Management**: No status in Stage 1
- **Computation Decision**: Transform (Stage 1 - creation only)
- **Reasoning**: In Stage 1, only creation is needed via interaction
- **Dependencies**: AppointDormHead interaction
- **Calculation Method**: Create when dormHead appointed

### Relation Properties

#### Property: appointedAt
- **Type**: number
- **Purpose**: Appointment timestamp
- **Computation Decision**: defaultValue
- **Reasoning**: Set once at creation
- **Calculation Method**: Math.floor(Date.now()/1000)

#### Property: appointedBy
- **Type**: string
- **Purpose**: Admin who appointed
- **Computation Decision**: None (set during creation)
- **Reasoning**: Captured from interaction user

## Relation: UserViolationRelation

### Relation Analysis
- **Purpose**: Links violations to users
- **Creation**: Automatically when ViolationRecord created
- **Deletion Requirements**: Never (audit trail)
- **Update Requirements**: None
- **State Management**: None needed
- **Computation Decision**: None
- **Reasoning**: Created automatically with ViolationRecord via entity reference
- **Dependencies**: N/A (automatic with ViolationRecord)
- **Calculation Method**: N/A (automatic)

## Relation: UserEvictionRequestRelation

### Relation Analysis
- **Purpose**: Links eviction requests to target users
- **Creation**: Automatically when EvictionRequest created
- **Deletion Requirements**: Never (audit trail)
- **Update Requirements**: None
- **State Management**: None needed
- **Computation Decision**: None
- **Reasoning**: Created automatically with EvictionRequest via entity reference
- **Dependencies**: N/A (automatic with EvictionRequest)
- **Calculation Method**: N/A (automatic)

## Relation: DormHeadEvictionRequestRelation

### Relation Analysis
- **Purpose**: Links eviction requests to requesting dormHead
- **Creation**: Automatically when EvictionRequest created
- **Deletion Requirements**: Never (audit trail)
- **Update Requirements**: None
- **State Management**: None needed
- **Computation Decision**: None
- **Reasoning**: Created automatically with EvictionRequest via entity reference
- **Dependencies**: N/A (automatic with EvictionRequest)
- **Calculation Method**: N/A (automatic)

## Summary of Computation Decisions

### Entity-Level Computations
1. **Dormitory**: Transform from InteractionEventEntity (CreateDormitory)
2. **Bed**: Transform from Dormitory (auto-create based on capacity)
3. **ViolationRecord**: Transform from InteractionEventEntity (RecordViolation)
4. **EvictionRequest**: Transform from InteractionEventEntity (SubmitEvictionRequest)
5. **User**: No computation (external creation)

### Property Computations
1. **StateMachine Properties**:
   - User.role (student → dormHead)
   - User.status (active → evicted)
   - User.evictedAt (timestamp on eviction)
   - Bed.status (vacant ↔ occupied)
   - Bed.assignedAt (timestamp on assignment)
   - EvictionRequest.status (pending → approved/rejected)
   - EvictionRequest.decidedAt (timestamp on decision)
   - EvictionRequest.adminNotes (set on decision)

2. **Computed Properties**:
   - User.points: Custom (100 - sum of violations, min 0)
   - User.isEligibleForEviction: computed function (points < 60)
   - Dormitory.occupancy: Count with filter (occupied beds)
   - Dormitory.availableBeds: computed function (capacity - occupancy)
   - Dormitory.occupancyRate: computed function (occupancy/capacity × 100)

3. **DefaultValue Properties**:
   - All createdAt timestamps
   - Initial status values
   - Relation timestamps (assignedAt, appointedAt)

### Relation Computations
1. **StateMachine Relations** (hard delete):
   - UserDormitoryRelation (create on assign, delete on evict)
   - UserBedRelation (create on assign, delete on evict)

2. **Transform Relations**:
   - DormitoryDormHeadRelation (create on appointment)

3. **No Computation** (automatic with entity):
   - DormitoryBedRelation (with Bed creation)
   - UserViolationRelation (with ViolationRecord)
   - UserEvictionRequestRelation (with EvictionRequest)
   - DormHeadEvictionRequestRelation (with EvictionRequest)

## Implementation Notes

1. **StateNode Declaration**: All StateNodes must be declared as variables before use in StateMachine
2. **Transform Placement**: Transform only in Entity/Relation computation, never in Property
3. **ID Generation**: Never manually specify IDs in Transform callbacks
4. **Strong Consistency**: Data-derived properties use Count/Summation/computed, not StateMachine
5. **Deletion Strategy**: Using hard delete for UserDormitoryRelation and UserBedRelation as audit trail not needed
6. **Timestamp Format**: Using Unix timestamps in seconds (Math.floor(Date.now()/1000))
7. **Relation Creation**: Most relations created automatically via entity references in Transform