# 宿舍管理系统详细需求分析

## 1. 系统角色分析

### 1.1 用户角色
- **系统管理员 (admin)**: 拥有最高权限，可以管理整个系统
- **宿舍长 (dormHead)**: 由管理员指定，管理特定宿舍的日常事务
- **学生 (student)**: 普通用户，可以被分配到宿舍

### 1.2 角色权限矩阵
| 操作 | 系统管理员 | 宿舍长 | 学生 |
|------|-----------|--------|------|
| 创建宿舍 | ✓ | ✗ | ✗ |
| 指定宿舍长 | ✓ | ✗ | ✗ |
| 分配用户到宿舍 | ✓ | ✗ | ✗ |
| 创建扣分规则 | ✓ | ✗ | ✗ |
| 对用户扣分 | ✓ | ✓ | ✗ |
| 申请踢出用户 | ✗ | ✓ | ✗ |
| 批准踢出申请 | ✓ | ✗ | ✗ |
| 查看宿舍信息 | ✓ | ✓(自己管理的) | ✓(自己所在的) |

## 2. 数据实体分析

### 2.1 用户 (User)
**用途**: 系统中的所有人员
**属性**:
- id: string (系统生成)
- name: string (姓名)
- email: string (邮箱，唯一标识)
- role: string (角色: admin/dormHead/student)
- totalScore: number (当前总分数，默认100)
- status: string (状态: active/kicked/suspended)

### 2.2 宿舍 (Dormitory)
**用途**: 宿舍建筑单位
**属性**:
- id: string (系统生成)
- name: string (宿舍名称，如"A栋101")
- capacity: number (床位数量，4-6床)
- currentOccupancy: number (当前入住人数)
- status: string (状态: active/inactive/maintenance)

### 2.3 扣分规则 (ScoreRule)
**用途**: 定义各种违规行为的扣分标准
**属性**:
- id: string (系统生成)
- name: string (规则名称，如"晚归")
- description: string (规则描述)
- scoreDeduction: number (扣分数值)
- isActive: boolean (规则是否生效)

### 2.4 扣分记录 (ScoreRecord)
**用途**: 记录用户的具体扣分情况
**属性**:
- id: string (系统生成)
- reason: string (扣分原因)
- score: number (扣分数值)
- createdAt: number (扣分时间戳)
- operatorNotes: string (操作员备注)

### 2.5 踢出申请 (KickRequest)
**用途**: 宿舍长申请踢出某用户的记录
**属性**:
- id: string (系统生成)
- reason: string (申请理由)
- status: string (申请状态: pending/approved/rejected)
- createdAt: number (申请时间)
- processedAt: number (处理时间)
- adminNotes: string (管理员处理备注)

## 3. 实体关系分析

### 3.1 用户-宿舍关系 (UserDormitoryRelation)
- **类型**: n:1 (多个用户对应一个宿舍)
- **用途**: 记录用户的宿舍分配
- **源属性**: `dormitory` (在User实体上)
- **目标属性**: `residents` (在Dormitory实体上)
- **关系属性**:
  - assignedAt: number (分配时间)
  - bedNumber: number (床位号 1-6)
  - status: string (分配状态: active/inactive)

### 3.2 宿舍长-宿舍关系 (DormHeadDormitoryRelation)
- **类型**: 1:1 (一个宿舍长对应一个宿舍)
- **用途**: 记录宿舍长的管理权限
- **源属性**: `managedDormitory` (在User实体上)
- **目标属性**: `dormHead` (在Dormitory实体上)
- **关系属性**:
  - appointedAt: number (任命时间)
  - status: string (任命状态: active/inactive)

### 3.3 用户-扣分记录关系 (UserScoreRecordRelation)
- **类型**: 1:n (一个用户对应多个扣分记录)
- **源属性**: `scoreRecords` (在User实体上)
- **目标属性**: `user` (在ScoreRecord实体上)

### 3.4 扣分规则-扣分记录关系 (ScoreRuleRecordRelation)
- **类型**: 1:n (一个规则对应多个记录)
- **源属性**: `records` (在ScoreRule实体上)
- **目标属性**: `rule` (在ScoreRecord实体上)

### 3.5 踢出申请相关关系
- **申请人-踢出申请**: 1:n (宿舍长可以发起多个申请)
- **被申请人-踢出申请**: 1:n (用户可能被多次申请踢出)
- **宿舍-踢出申请**: 1:n (一个宿舍可能有多个踢出申请)

## 4. 业务流程分析

### 4.1 宿舍分配流程
1. 管理员创建宿舍
2. 管理员指定宿舍长
3. 管理员分配学生到宿舍的具体床位
4. 系统自动更新宿舍入住人数

### 4.2 扣分管理流程
1. 管理员创建扣分规则
2. 宿舍长或管理员发现违规行为
3. 根据规则对用户扣分
4. 系统自动更新用户总分

### 4.3 踢出申请流程
1. 宿舍长发现用户扣分达到阈值
2. 宿舍长提交踢出申请
3. 管理员审核申请
4. 如果批准：用户被踢出，释放床位
5. 如果拒绝：申请被驳回，用户继续住宿

## 5. 业务规则分析

### 5.1 宿舍管理规则
- 每个宿舍容量限制：4-6床位
- 每个用户只能分配到一个宿舍的一个床位
- 用户被踢出后，其床位自动释放
- 宿舍长必须是该宿舍的住户之一

### 5.2 扣分规则
- 用户初始分数：100分
- 扣分后不能低于0分
- 分数低于20分时，允许宿舍长申请踢出
- 被踢出的用户不能再被分配到任何宿舍

### 5.3 权限规则
- 只有管理员可以创建宿舍和指定宿舍长
- 只有管理员可以分配用户到宿舍
- 宿舍长只能管理自己负责的宿舍
- 宿舍长只能对自己宿舍的住户扣分
- 只有管理员可以批准踢出申请

## 6. 技术约束

### 6.1 数据约束
- 用户邮箱必须唯一
- 宿舍名称必须唯一
- 床位号在同一宿舍内必须唯一
- 分数不能为负数
- 宿舍容量必须在4-6之间

### 6.2 业务约束
- 用户只能有一个角色
- 一个宿舍只能有一个宿舍长
- 用户被踢出后状态不可逆转
- 扣分记录不可删除，只能查看

## 7. 异常情况处理

### 7.1 数据异常
- 宿舍满员时尝试分配新用户
- 用户已有宿舍时尝试重新分配
- 对不存在的用户进行操作
- 非宿舍长尝试申请踢出用户

### 7.2 权限异常
- 越权操作拒绝
- 未登录用户拒绝访问
- 已被踢出用户尝试操作

### 7.3 业务逻辑异常
- 宿舍长尝试踢出自己
- 对分数充足的用户申请踢出
- 重复申请踢出同一用户