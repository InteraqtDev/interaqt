# 宿舍管理系统详细需求分析

## 1. 系统概述
宿舍管理系统用于管理学生宿舍的分配、管理和纪律管理，支持层级管理结构。

## 2. 用户角色分析

### 2.1 管理员 (Admin)
- **权限**：系统最高权限
- **职责**：
  - 创建和管理宿舍
  - 指定宿舍长
  - 分配学生到宿舍
  - 审批踢出申请
  - 管理扣分规则

### 2.2 宿舍长 (DormHead)
- **权限**：管理指定宿舍
- **职责**：
  - 监督宿舍成员行为
  - 记录违规行为和扣分
  - 申请踢出问题学生
  - 查看宿舍成员信息

### 2.3 学生 (Student)
- **权限**：基本用户权限
- **职责**：
  - 查看自己的宿舍信息
  - 查看自己的扣分记录
  - 遵守宿舍规定

## 3. 核心实体分析

### 3.1 用户 (User)
- **属性**：
  - id: 唯一标识符
  - name: 姓名
  - email: 邮箱（唯一）
  - role: 角色（admin/dormHead/student）
  - totalScore: 总扣分（计算属性）
  - status: 用户状态（active/kicked）

### 3.2 宿舍 (Dormitory)
- **属性**：
  - id: 唯一标识符
  - name: 宿舍名称
  - capacity: 床位数量（4-6）
  - currentOccupancy: 当前入住人数（计算属性）
  - availableBeds: 可用床位数（计算属性）

### 3.3 床位 (Bed)
- **属性**：
  - id: 唯一标识符
  - number: 床位号（1-6）
  - isOccupied: 是否被占用（计算属性）

### 3.4 扣分记录 (DeductionRecord)
- **属性**：
  - id: 唯一标识符
  - reason: 扣分原因
  - points: 扣分分数
  - createdAt: 创建时间
  - status: 记录状态（active/cancelled）

### 3.5 踢出申请 (KickoutRequest)
- **属性**：
  - id: 唯一标识符
  - reason: 申请理由
  - status: 申请状态（pending/approved/rejected）
  - createdAt: 申请时间
  - processedAt: 处理时间

### 3.6 扣分规则 (DeductionRule)
- **属性**：
  - id: 唯一标识符
  - name: 规则名称
  - description: 规则描述
  - points: 扣分数
  - isActive: 是否启用

## 4. 关系分析

### 4.1 用户-宿舍关系 (UserDormitoryRelation)
- **类型**：n:1（多个用户对应一个宿舍）
- **属性**：
  - assignedAt: 分配时间
  - status: 分配状态（active/inactive）

### 4.2 用户-床位关系 (UserBedRelation)
- **类型**：1:1（一个用户对应一个床位）
- **属性**：
  - assignedAt: 分配时间
  - status: 使用状态（active/inactive）

### 4.3 宿舍-床位关系 (DormitoryBedRelation)
- **类型**：1:n（一个宿舍对应多个床位）
- **属性**：无额外属性

### 4.4 宿舍-宿舍长关系 (DormitoryHeadRelation)
- **类型**：1:1（一个宿舍对应一个宿舍长）
- **属性**：
  - appointedAt: 任命时间
  - status: 任职状态（active/inactive）

### 4.5 用户-扣分记录关系 (UserDeductionRelation)
- **类型**：1:n（一个用户对应多个扣分记录）
- **属性**：无额外属性

### 4.6 踢出申请相关关系
- **申请人-踢出申请关系**：1:n（宿舍长可以发起多个申请）
- **被申请人-踢出申请关系**：1:n（学生可以被多次申请）
- **处理人-踢出申请关系**：1:n（管理员处理多个申请）

## 5. 业务流程分析

### 5.1 宿舍分配流程
1. 管理员创建宿舍
2. 系统自动创建对应数量的床位
3. 管理员指定宿舍长
4. 管理员分配学生到宿舍的具体床位

### 5.2 扣分管理流程
1. 宿舍长发现违规行为
2. 根据扣分规则记录扣分
3. 系统自动更新学生总扣分
4. 达到阈值时，宿舍长可申请踢出

### 5.3 踢出申请流程
1. 宿舍长提交踢出申请
2. 管理员审核申请
3. 批准后，学生被踢出宿舍
4. 释放床位，更新相关状态

## 6. 业务规则约束

### 6.1 宿舍管理规则
- 每个宿舍床位数为4-6个
- 每个用户只能分配到一个宿舍的一个床位
- 每个宿舍只能有一个宿舍长
- 宿舍长必须是该宿舍的成员

### 6.2 扣分管理规则
- 扣分阈值：达到30分可申请踢出
- 只有宿舍长可以给本宿舍成员扣分
- 扣分记录不可删除，只能标记为取消
- 总扣分为所有有效扣分记录的总和

### 6.3 踢出申请规则
- 只有宿舍长可以申请踢出本宿舍成员
- 被申请人总扣分必须≥30分
- 每个学生同时只能有一个待处理的踢出申请
- 管理员批准后，学生状态变为kicked，释放床位

### 6.4 权限控制规则
- 管理员：全部操作权限
- 宿舍长：只能管理自己负责的宿舍
- 学生：只能查看自己的信息

## 7. 系统状态管理

### 7.1 用户状态
- active: 正常状态
- kicked: 被踢出状态

### 7.2 踢出申请状态
- pending: 待处理
- approved: 已批准
- rejected: 已拒绝

### 7.3 扣分记录状态
- active: 有效
- cancelled: 已取消

### 7.4 床位分配状态
- active: 正在使用
- inactive: 已释放

## 8. 预定义扣分规则

### 8.1 卫生类违规
- 个人卫生不达标：5分
- 宿舍卫生不合格：10分
- 垃圾未及时清理：3分

### 8.2 纪律类违规
- 晚归（22:00后）：5分
- 夜不归宿：15分
- 宿舍内吵闹：8分
- 违规使用电器：10分

### 8.3 安全类违规
- 私拉电线：20分
- 宿舍内吸烟：15分
- 擅自留宿他人：10分

## 9. 技术实现考虑

### 9.1 数据一致性
- 宿舍容量与床位数量一致性
- 用户分配状态与床位占用状态一致性
- 扣分记录与总扣分计算一致性

### 9.2 并发控制
- 床位分配的并发控制
- 踢出申请的状态变更控制
- 扣分记录的并发添加控制

### 9.3 业务逻辑验证
- 分配前的容量检查
- 踢出申请的条件检查
- 权限验证的多层控制