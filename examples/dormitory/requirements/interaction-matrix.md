# 宿舍管理系统交互矩阵

## 用户角色定义

### Admin (管理员)
- 系统最高权限用户
- 可以执行所有管理操作
- 负责系统配置和用户权限管理

### DormHead (宿舍长)
- 宿舍管理员角色
- 管理指定宿舍的学生
- 记录违规行为并申请踢出

### Student (学生)
- 基础用户角色
- 只能查看个人相关信息
- 被动接受管理

## 交互权限矩阵

| 交互名称 | Admin | DormHead | Student | 描述 |
|---------|-------|----------|---------|------|
| **用户管理** | | | | |
| CreateUser | ✅ | ❌ | ❌ | 创建用户账号 |
| AssignDormHead | ✅ | ❌ | ❌ | 指定宿舍长 |
| GetUserInfo | ✅ | ✅(限本宿舍) | ✅(限本人) | 获取用户信息 |
| **宿舍管理** | | | | |
| CreateDormitory | ✅ | ❌ | ❌ | 创建宿舍 |
| AssignUserToBed | ✅ | ❌ | ❌ | 分配床位 |
| GetDormitoryInfo | ✅ | ✅(限所管宿舍) | ✅(限所住宿舍) | 获取宿舍信息 |
| **行为管理** | | | | |
| RecordBehavior | ✅ | ✅(限本宿舍学生) | ❌ | 记录违规行为 |
| GetBehaviorRecords | ✅ | ✅(限本宿舍学生) | ✅(限本人) | 查看行为记录 |
| **踢出管理** | | | | |
| CreateExpulsionRequest | ❌ | ✅(限本宿舍学生) | ❌ | 申请踢出学生 |
| ProcessExpulsionRequest | ✅ | ❌ | ❌ | 处理踢出申请 |
| GetExpulsionRequests | ✅ | ✅(限本人申请) | ❌ | 查看踢出申请 |

## 交互详细设计

### 用户管理交互

#### CreateUser
- **权限**: Admin only
- **业务规则**: 
  - 邮箱唯一性检查
  - 必填字段验证
- **测试用例**: TC001

#### AssignDormHead  
- **权限**: Admin only
- **业务规则**:
  - 目标用户必须存在
  - 宿舍必须存在且未分配宿舍长
  - 用户角色自动更新为dormHead
- **测试用例**: TC003

#### GetUserInfo
- **权限**: 
  - Admin: 所有用户
  - DormHead: 本宿舍学生
  - Student: 本人信息
- **业务规则**: 基于角色的数据访问控制
- **测试用例**: TC101 (权限测试)

### 宿舍管理交互

#### CreateDormitory
- **权限**: Admin only
- **业务规则**:
  - 床位数必须在4-6之间
  - 宿舍名称唯一性
  - 自动创建对应数量的床位
- **测试用例**: TC002, TC202

#### AssignUserToBed
- **权限**: Admin only
- **业务规则**:
  - 用户只能分配到一个床位
  - 床位必须可用
  - 创建用户-床位分配关系
- **测试用例**: TC004, TC201, TC203

#### GetDormitoryInfo
- **权限**:
  - Admin: 所有宿舍
  - DormHead: 所管理宿舍
  - Student: 所居住宿舍
- **业务规则**: 基于角色和关系的访问控制

### 行为管理交互

#### RecordBehavior
- **权限**: 
  - Admin: 所有学生
  - DormHead: 本宿舍学生
- **业务规则**:
  - 扣分值自动累计到用户总分
  - 记录时间和记录人信息
- **测试用例**: TC005, TC103

#### GetBehaviorRecords
- **权限**:
  - Admin: 所有记录
  - DormHead: 本宿舍学生记录
  - Student: 本人记录
- **业务规则**: 基于角色的数据访问控制

### 踢出管理交互

#### CreateExpulsionRequest
- **权限**: DormHead only (针对本宿舍学生)
- **业务规则**:
  - 目标学生扣分达到阈值(100分)
  - 同一学生不能有pending状态的申请
  - 自动设置申请状态为pending
- **测试用例**: TC006, TC204

#### ProcessExpulsionRequest
- **权限**: Admin only
- **业务规则**:
  - 申请状态必须为pending
  - 批准后自动执行踢出操作
  - 更新用户状态和床位分配
- **测试用例**: TC007, TC205

#### GetExpulsionRequests
- **权限**:
  - Admin: 所有申请
  - DormHead: 本人提交的申请
- **业务规则**: 基于申请人的访问控制

## 业务规则总结

### 访问控制规则
1. **层级权限**: Admin > DormHead > Student
2. **范围限制**: DormHead只能管理所属宿舍
3. **数据隔离**: Student只能访问个人数据

### 业务约束规则  
1. **唯一性约束**: 用户邮箱唯一、宿舍名称唯一
2. **容量约束**: 宿舍床位4-6个、用户单床位分配
3. **状态约束**: 踢出需要达到扣分阈值
4. **流程约束**: 踢出申请需要管理员审批

### 数据一致性规则
1. **关联更新**: 分配床位时自动更新占用状态
2. **级联操作**: 踢出用户时自动清理床位分配
3. **计算属性**: 扣分自动累计、可用床位自动计算

## 测试覆盖确认

### 核心业务逻辑测试
- ✅ 所有CRUD操作都有对应测试用例
- ✅ 关键业务流程(分配、踢出)都有测试覆盖
- ✅ 计算属性和状态更新都有验证

### 权限控制测试
- ✅ 每个角色的权限边界都有测试
- ✅ 跨角色访问限制都有验证
- ✅ 数据范围访问控制都有检查

### 业务规则测试
- ✅ 所有约束条件都有违规测试
- ✅ 边界值和异常情况都有覆盖
- ✅ 状态转换和流程控制都有验证