# 宿舍管理系统交互矩阵

## 角色权限矩阵

| Interaction | Admin | DormHead | Student | 权限控制 | 业务规则验证 |
|-------------|-------|----------|---------|----------|-------------|
| **宿舍管理** |
| CreateDormitory | ✅ | ❌ | ❌ | role === 'admin' | capacity: 4-6 |
| UpdateDormitory | ✅ | ❌ | ❌ | role === 'admin' | capacity: 4-6 |
| DeleteDormitory | ✅ | ❌ | ❌ | role === 'admin' | 必须无学生入住 |
| GetDormitoryInfo | ✅ | ✅ | ✅ | - | - |
| **用户管理** |
| AssignDormHead | ✅ | ❌ | ❌ | role === 'admin' | 目标用户role为student |
| RemoveDormHead | ✅ | ❌ | ❌ | role === 'admin' | - |
| AssignUserToBed | ✅ | ❌ | ❌ | role === 'admin' | 容量限制，用户未分配 |
| RemoveUserFromBed | ✅ | ❌ | ❌ | role === 'admin' | - |
| **纪律管理** |
| RecordDiscipline | ✅ | ✅* | ❌ | admin或本宿舍宿舍长 | 分数不能为负 |
| CancelDiscipline | ✅ | ✅* | ❌ | admin或本宿舍宿舍长 | 记录必须存在且active |
| **踢出管理** |
| CreateExpelRequest | ❌ | ✅* | ❌ | 本宿舍宿舍长 | 目标分数<60，无pending申请 |
| ReviewExpelRequest | ✅ | ❌ | ❌ | role === 'admin' | 申请状态为pending |
| **查询操作** |
| GetUserInfo | ✅ | ✅ | ✅ | - | - |
| GetDisciplineRecords | ✅ | ✅* | ✅** | admin/本宿舍宿舍长/本人 | - |
| GetExpelRequests | ✅ | ✅* | ❌ | admin或申请者 | - |

*注: 仅限对本宿舍学生操作  
**注: 仅能查看自己的记录

## 详细权限说明

### 管理员 (Admin) 权限
- **宿舍管理**: 完全控制权限，可以创建、修改、删除宿舍
- **用户分配**: 可以指定宿舍长，分配学生到床位
- **纪律管理**: 可以对任何学生记录纪律，取消纪律记录
- **申请审核**: 审核所有踢出申请
- **查询权限**: 查看所有信息

### 宿舍长 (DormHead) 权限
- **宿舍管理**: 只读权限，可以查看宿舍信息
- **纪律管理**: 只能对**本宿舍**学生进行纪律记录和取消
- **踢出申请**: 只能对**本宿舍**学生发起踢出申请
- **查询权限**: 可以查看本宿舍学生信息和纪律记录

### 学生 (Student) 权限
- **查询权限**: 只能查看自己的信息和纪律记录
- **其他操作**: 无主动操作权限

## 业务规则详细说明

### 宿舍管理规则
1. **创建宿舍**:
   - 容量必须在4-6之间
   - 宿舍名称不能重复
   - 自动创建对应数量的床位

2. **删除宿舍**:
   - 必须先清空所有学生
   - 删除时同时删除所有床位

### 用户分配规则
1. **指定宿舍长**:
   - 目标用户当前角色必须为student
   - 一个宿舍只能有一个宿舍长
   - 指定后用户角色自动变为dormHead

2. **分配床位**:
   - 用户当前未分配到任何床位
   - 目标床位当前未被占用
   - 不能超过宿舍容量限制
   - 用户状态必须为active

### 纪律管理规则
1. **记录纪律**:
   - 扣分后用户总分不能为负数
   - 必须有明确的扣分原因
   - 扣分范围1-15分

2. **取消纪律**:
   - 记录必须存在且状态为active
   - 取消后自动恢复对应分数

### 踢出申请规则
1. **发起申请**:
   - 目标用户分数必须低于60分
   - 目标用户当前没有pending状态的申请
   - 不能申请踢出自己
   - 必须是同一宿舍的学生

2. **审核申请**:
   - 申请状态必须为pending
   - 同意后用户状态变为expelled，释放床位
   - 拒绝后申请状态变为rejected，其他不变

## 交互依赖关系

### 前置依赖
1. **分配宿舍长**: 需要先创建宿舍和用户
2. **分配床位**: 需要先创建宿舍（自动创建床位）
3. **记录纪律**: 需要用户已被分配到宿舍
4. **踢出申请**: 需要宿舍长已指定，用户分数满足条件

### 数据完整性约束
1. **级联删除**: 删除宿舍时必须先清理所有关联数据
2. **状态同步**: 用户状态变更时同步更新相关关系
3. **计数更新**: 床位分配变化时自动更新宿舍入住人数

## 错误处理矩阵

| 错误类型 | 权限错误 | 业务规则错误 | 数据验证错误 |
|----------|----------|-------------|-------------|
| **返回码** | 403 | 400 | 422 |
| **处理方式** | 拒绝执行 | 拒绝执行 | 拒绝执行 |
| **错误信息** | "Permission denied" | "Business rule violation" | "Validation failed" |

## 安全考量

### 数据访问控制
- 所有查询操作都要验证用户身份
- 敏感信息（如纪律记录）只对授权用户可见
- 防止用户越权访问其他宿舍数据

### 操作审计
- 记录所有关键操作（分配、纪律、踢出）的执行者和时间
- 保留操作历史用于追溯
- 重要状态变更需要记录原因

### 并发控制
- 防止同时分配同一床位给多个用户
- 防止重复创建相同名称的宿舍
- 申请状态变更的原子性保证