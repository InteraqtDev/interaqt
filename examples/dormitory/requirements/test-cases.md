# 宿舍管理系统测试用例

## 测试阶段说明

**🔴 关键: 所有测试用例必须基于交互操作(Interactions)，不能基于实体/关系操作**

### 阶段1: 核心业务逻辑测试 (优先实现)
### 阶段2: 权限测试 (核心逻辑正常后实现)
### 阶段3: 业务规则测试 (核心逻辑正常后实现)

---

## 阶段1: 核心业务逻辑测试

### TC001: 创建宿舍 (通过 CreateDormitory 交互)
- **交互**: CreateDormitory
- **前置条件**: 管理员已登录
- **输入数据**: 
  ```json
  {
    name: "1号楼101",
    capacity: 4
  }
  ```
- **预期结果**:
  1. 创建新的宿舍记录
  2. 宿舍状态为可用
  3. 自动创建4个床位(床位号1-4)
  4. 所有床位状态为'available'
  5. occupiedCount为0，availableCount为4
- **后置验证**: 宿舍出现在宿舍列表中，床位正确创建

### TC002: 创建宿舍 - 无效数据 (通过 CreateDormitory 交互)
- **交互**: CreateDormitory
- **前置条件**: 管理员已登录
- **输入数据**: 
  ```json
  {
    name: "",
    capacity: 7  // 超出有效范围
  }
  ```
- **预期结果**:
  1. 交互返回错误
  2. 错误类型为"validation failed"
  3. 没有创建宿舍记录
  4. 没有创建床位记录
- **注意**: 不要使用storage.create测试 - 它会绕过验证！

### TC003: 创建用户 (通过 CreateUser 交互)
- **交互**: CreateUser
- **前置条件**: 管理员已登录
- **输入数据**: 
  ```json
  {
    name: "张三",
    email: "zhangsan@example.com",
    role: "student"
  }
  ```
- **预期结果**:
  1. 创建新的用户记录
  2. 用户初始分数为100
  3. 用户状态为'active'
  4. 创建时间为当前时间
- **后置验证**: 用户出现在用户列表中

### TC004: 分配用户到宿舍 (通过 AssignUserToDormitory 交互)
- **交互**: AssignUserToDormitory
- **前置条件**: 
  - 存在可用宿舍(有空床位)
  - 存在活跃用户
  - 用户未被分配到其他宿舍
- **输入数据**: 
  ```json
  {
    userId: "user123",
    dormitoryId: "dorm456",
    bedNumber: 1
  }
  ```
- **预期结果**:
  1. 创建用户-宿舍关系记录
  2. 创建用户-床位关系记录
  3. 床位状态变为'occupied'
  4. 宿舍occupiedCount自动+1
  5. 宿舍availableCount自动-1
  6. 分配时间为当前时间
- **后置验证**: 用户.dormitory指向正确宿舍，床位.occupant指向正确用户

### TC005: 指定宿舍长 (通过 AssignDormitoryHead 交互)
- **交互**: AssignDormitoryHead
- **前置条件**: 
  - 用户已分配到目标宿舍
  - 用户角色为'student'
  - 宿舍当前没有宿舍长
- **输入数据**: 
  ```json
  {
    userId: "user123",
    dormitoryId: "dorm456"
  }
  ```
- **预期结果**:
  1. 用户角色更新为'dormHead'
  2. 创建宿舍-宿舍长关系
  3. 任命时间为当前时间
- **后置验证**: 用户.managedDormitory指向正确宿舍，宿舍.head指向正确用户

### TC006: 用户扣分 (通过 DeductUserScore 交互)
- **交互**: DeductUserScore
- **前置条件**: 
  - 宿舍长已指定
  - 目标用户在宿舍长管理的宿舍内
- **输入数据**: 
  ```json
  {
    targetUserId: "user123",
    reason: "晚归",
    points: 5
  }
  ```
- **预期结果**:
  1. 创建扣分记录
  2. 用户总分数自动-5
  3. 扣分记录关联到用户
  4. 创建时间为当前时间
- **后置验证**: 用户分数正确更新，扣分记录包含在用户.scoreRecords中

### TC007: 提交踢人申请 (通过 SubmitExpelRequest 交互)
- **交互**: SubmitExpelRequest
- **前置条件**: 
  - 宿舍长已指定
  - 目标用户在宿舍长管理的宿舍内且分数低于60
- **输入数据**: 
  ```json
  {
    targetUserId: "user123",
    reason: "多次违反宿舍规定"
  }
  ```
- **预期结果**:
  1. 创建踢人申请记录
  2. 申请状态为'pending'
  3. 申请时间为当前时间
  4. 建立申请人-申请关系
  5. 建立被申请人-申请关系
- **后置验证**: 申请出现在相关用户的申请列表中

### TC008: 处理踢人申请 - 批准 (通过 ProcessExpelRequest 交互)
- **交互**: ProcessExpelRequest
- **前置条件**: 
  - 存在待处理的踢人申请
  - 管理员已登录
- **输入数据**: 
  ```json
  {
    requestId: "request123",
    decision: "approved",
    comment: "同意踢出"
  }
  ```
- **预期结果**:
  1. 申请状态更新为'approved'
  2. 目标用户状态更新为'expelled'
  3. 释放用户占用的床位(状态变为'available')
  4. 断开用户-宿舍关系
  5. 断开用户-床位关系
  6. 宿舍occupiedCount自动-1
  7. 宿舍availableCount自动+1
  8. 处理时间为当前时间
- **后置验证**: 床位重新可用，宿舍统计正确更新

### TC009: 处理踢人申请 - 拒绝 (通过 ProcessExpelRequest 交互)
- **交互**: ProcessExpelRequest
- **前置条件**: 
  - 存在待处理的踢人申请
  - 管理员已登录
- **输入数据**: 
  ```json
  {
    requestId: "request123",
    decision: "rejected",
    comment: "证据不足"
  }
  ```
- **预期结果**:
  1. 申请状态更新为'rejected'
  2. 目标用户状态保持'active'
  3. 用户宿舍分配保持不变
  4. 处理时间为当前时间
- **后置验证**: 用户继续占用原床位

### TC010: 查看宿舍成员 (通过 ViewDormitoryMembers 交互)
- **交互**: ViewDormitoryMembers
- **前置条件**: 宿舍中有已分配的用户
- **输入数据**: 
  ```json
  {
    dormitoryId: "dorm456"
  }
  ```
- **预期结果**:
  1. 返回宿舍内所有活跃用户列表
  2. 包含用户基本信息和床位信息
  3. 包含用户当前分数
- **后置验证**: 返回的用户列表准确反映当前宿舍状态

---

## 阶段2: 权限测试 (在核心逻辑工作后实现)

### TC011: 创建宿舍 - 权限测试
- **交互**: CreateDormitory
- **测试阶段**: 权限 (核心逻辑后实现)
- **前置条件**: 非管理员用户(学生)已登录
- **输入数据**: 有效的宿舍创建数据
- **预期结果**:
  1. 交互返回权限错误
  2. 错误消息指示权限不足
  3. 没有创建宿舍记录
- **注意**: 这测试权限控制，不是核心功能

### TC012: 扣分操作 - 权限测试
- **交互**: DeductUserScore
- **测试阶段**: 权限 (核心逻辑后实现)
- **前置条件**: 非宿舍长用户尝试扣分
- **输入数据**: 有效的扣分数据
- **预期结果**:
  1. 交互返回权限错误
  2. 错误消息指示只有宿舍长可操作
  3. 没有创建扣分记录
  4. 用户分数保持不变

### TC013: 跨宿舍扣分 - 权限测试
- **交互**: DeductUserScore
- **测试阶段**: 权限 (核心逻辑后实现)
- **前置条件**: 宿舍长A尝试给宿舍B的用户扣分
- **输入数据**: 其他宿舍用户的扣分数据
- **预期结果**:
  1. 交互返回权限错误
  2. 错误消息指示只能管理本宿舍用户
  3. 没有创建扣分记录

### TC014: 踢人申请 - 权限测试
- **交互**: SubmitExpelRequest
- **测试阶段**: 权限 (核心逻辑后实现)
- **前置条件**: 普通学生尝试提交踢人申请
- **输入数据**: 有效的踢人申请数据
- **预期结果**:
  1. 交互返回权限错误
  2. 错误消息指示只有宿舍长可申请
  3. 没有创建申请记录

### TC015: 处理踢人申请 - 权限测试
- **交互**: ProcessExpelRequest
- **测试阶段**: 权限 (核心逻辑后实现)
- **前置条件**: 非管理员用户尝试处理申请
- **输入数据**: 有效的处理决定数据
- **预期结果**:
  1. 交互返回权限错误
  2. 错误消息指示只有管理员可处理
  3. 申请状态保持pending

---

## 阶段3: 业务规则测试 (在核心逻辑工作后实现)

### TC016: 宿舍容量限制 - 业务规则测试
- **交互**: CreateDormitory
- **测试阶段**: 业务规则 (核心逻辑后实现)
- **前置条件**: 管理员已登录
- **输入数据**: 
  ```json
  {
    name: "测试宿舍",
    capacity: 3  // 低于最小值4
  }
  ```
- **预期结果**:
  1. 交互返回错误
  2. 错误消息指示容量必须在4-6之间
  3. 没有创建宿舍记录
- **注意**: 这测试业务规则验证，不是核心功能

### TC017: 宿舍满员分配 - 业务规则测试
- **交互**: AssignUserToDormitory
- **测试阶段**: 业务规则 (核心逻辑后实现)
- **前置条件**: 宿舍已满员(所有床位都被占用)
- **输入数据**: 尝试分配新用户到满员宿舍
- **预期结果**:
  1. 交互返回错误
  2. 错误消息指示宿舍已满
  3. 没有创建分配关系
  4. 宿舍占用情况保持不变

### TC018: 重复分配床位 - 业务规则测试
- **交互**: AssignUserToDormitory
- **测试阶段**: 业务规则 (核心逻辑后实现)
- **前置条件**: 床位已被其他用户占用
- **输入数据**: 尝试分配用户到已占用床位
- **预期结果**:
  1. 交互返回错误
  2. 错误消息指示床位已被占用
  3. 没有创建新的分配关系

### TC019: 用户重复分配 - 业务规则测试
- **交互**: AssignUserToDormitory
- **测试阶段**: 业务规则 (核心逻辑后实现)
- **前置条件**: 用户已被分配到其他宿舍
- **输入数据**: 尝试将已分配用户分配到新宿舍
- **预期结果**:
  1. 交互返回错误
  2. 错误消息指示用户已有宿舍分配
  3. 没有创建新的分配关系
  4. 原分配关系保持不变

### TC020: 分数不足踢人申请 - 业务规则测试
- **交互**: SubmitExpelRequest
- **测试阶段**: 业务规则 (核心逻辑后实现)
- **前置条件**: 
  - 宿舍长已指定
  - 目标用户分数为80分(高于60分阈值)
- **输入数据**: 尝试申请踢出高分用户
- **预期结果**:
  1. 交互返回错误
  2. 错误消息指示用户分数过高，不符合踢出条件
  3. 没有创建申请记录

### TC021: 非宿舍成员踢人申请 - 业务规则测试
- **交互**: SubmitExpelRequest
- **测试阶段**: 业务规则 (核心逻辑后实现)
- **前置条件**: 
  - 宿舍长A已指定
  - 目标用户在宿舍B(不是A管理的宿舍)
- **输入数据**: 尝试踢出其他宿舍的用户
- **预期结果**:
  1. 交互返回错误
  2. 错误消息指示只能申请踢出本宿舍成员
  3. 没有创建申请记录

### TC022: 扣分数值验证 - 业务规则测试
- **交互**: DeductUserScore
- **测试阶段**: 业务规则 (核心逻辑后实现)
- **前置条件**: 宿舍长和目标用户条件正常
- **输入数据**: 
  ```json
  {
    targetUserId: "user123",
    reason: "测试",
    points: -5  // 负数扣分
  }
  ```
- **预期结果**:
  1. 交互返回错误
  2. 错误消息指示扣分必须为正数
  3. 没有创建扣分记录
  4. 用户分数保持不变

### TC023: 重复踢人申请 - 业务规则测试
- **交互**: SubmitExpelRequest
- **测试阶段**: 业务规则 (核心逻辑后实现)
- **前置条件**: 
  - 对同一用户已存在pending状态的踢人申请
  - 宿舍长尝试再次提交申请
- **输入数据**: 对同一用户的新踢人申请
- **预期结果**:
  1. 交互返回错误
  2. 错误消息指示该用户已有待处理申请
  3. 没有创建新的申请记录

### TC024: 已处理申请重复处理 - 业务规则测试
- **交互**: ProcessExpelRequest
- **测试阶段**: 业务规则 (核心逻辑后实现)
- **前置条件**: 申请已被处理(状态为approved或rejected)
- **输入数据**: 尝试再次处理已处理的申请
- **预期结果**:
  1. 交互返回错误
  2. 错误消息指示申请已被处理
  3. 申请状态保持不变

---

## 测试数据准备

### 基础测试用户
```json
[
  {
    "name": "系统管理员",
    "email": "admin@example.com",
    "role": "admin"
  },
  {
    "name": "张三",
    "email": "zhangsan@example.com",
    "role": "student"
  },
  {
    "name": "李四",
    "email": "lisi@example.com",
    "role": "student"
  },
  {
    "name": "王五",
    "email": "wangwu@example.com",
    "role": "student"
  }
]
```

### 基础测试宿舍
```json
[
  {
    "name": "1号楼101",
    "capacity": 4
  },
  {
    "name": "1号楼102",
    "capacity": 6
  }
]
```

## 测试执行优先级

1. **阶段1优先**: TC001-TC010 必须全部通过才能进入下一阶段
2. **阶段2其次**: 在阶段1稳定后实现权限控制测试
3. **阶段3最后**: 在核心功能和权限都正常后实现业务规则测试

## 成功标准

- **阶段1**: 所有核心业务逻辑测试100%通过
- **阶段2**: 所有权限测试100%通过，且阶段1测试继续通过
- **阶段3**: 所有业务规则测试100%通过，且前两阶段测试继续通过

**🔴 关键提醒**: 如果阶段1测试失败，必须修复实现直到100%通过率，不能进入后续阶段！